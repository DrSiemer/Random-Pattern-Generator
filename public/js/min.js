function RandomPatternGenerator(c,b,a){this.$playfield=c;this.maxWidth=this.$playfield.data("maximum-x");this.maxHeight=this.$playfield.data("maximum-y");this.options=[];this.debugMode=false;this.tileHistory=b;this.tileDebugger=a;this.initialize=function(){this.options=["x","t","r","b","l","trbl","tr","tb","tl","rb","rl","bl","trb","trl","tbl","rbl","tr","tb","tl","rb","rl","bl","tr","tb","tl","rb","rl","bl","trb","trl","tbl","rbl","tr","tb","tl","rb","rl","bl","trb","trl","tbl","rbl","tr","tb","tl","rb","rl","bl"]}.bind(this);this.replaceTile=function(e){var d=this.options.slice(0);d=this.removeDirectionsForEdges(e,d);var f=d[Math.floor(Math.random()*d.length)];e.attr("src","/img/"+f+".jpg");this.tileHistory.resetTile(e);this.tileDebugger.resetTile(e);if(e.data("x")>1){this.fixTileConnectionsByPosition(e.data("x")-1,e.data("y"))}if(e.data("y")>1){this.fixTileConnectionsByPosition(e.data("x"),e.data("y")-1)}if(e.data("x")<(this.maxWidth-1)){this.fixTileConnectionsByPosition(e.data("x")+1,e.data("y"))}if(e.data("y")<(this.maxHeight-1)){this.fixTileConnectionsByPosition(e.data("x"),e.data("y")+1)}}.bind(this);this.removeDirectionsForEdges=function(e,d){if(e.data("x")==1){d=this.removeDirectionFromPossibilities(d,"l")}if(e.data("y")==1){d=this.removeDirectionFromPossibilities(d,"t")}if(e.data("x")==(this.maxWidth-1)){d=this.removeDirectionFromPossibilities(d,"r")}if(e.data("y")==(this.maxHeight-1)){d=this.removeDirectionFromPossibilities(d,"b")}return d}.bind(this);this.removeDirectionFromPossibilities=function(d,g){var f=[];for(var e=0,j=d.length;e<j;e++){if(d[e].indexOf(g)==-1){f.push(d[e])}}return f};this.requireDirectionFromPossibilities=function(d,g){var f=[];for(var e=0,j=d.length;e<j;e++){if(d[e].indexOf(g)!=-1){f.push(d[e])}}return f};this.fixTileConnectionsByPosition=function(d,j){var f=$('[data-x="'+d+'"][data-y="'+j+'"]');var e=this.options.slice(0);e=this.removeDirectionsForEdges(f,e);if(j>1){var i=$('[data-x="'+d+'"][data-y="'+(j-1)+'"]');if(this.getDirectionsOfTile(i).indexOf("b")!=-1){e=this.requireDirectionFromPossibilities(e,"t")}else{e=this.removeDirectionFromPossibilities(e,"t")}}if(d<(this.maxWidth-1)){var i=$('[data-x="'+(d+1)+'"][data-y="'+j+'"]');if(this.getDirectionsOfTile(i).indexOf("l")!=-1){e=this.requireDirectionFromPossibilities(e,"r")}else{e=this.removeDirectionFromPossibilities(e,"r")}}if(j<(this.maxHeight-1)){var i=$('[data-x="'+d+'"][data-y="'+(j+1)+'"]');if(this.getDirectionsOfTile(i).indexOf("t")!=-1){e=this.requireDirectionFromPossibilities(e,"b")}else{e=this.removeDirectionFromPossibilities(e,"b")}}if(d>1){var i=$('[data-x="'+(d-1)+'"][data-y="'+j+'"]');if(this.getDirectionsOfTile(i).indexOf("r")!=-1){e=this.requireDirectionFromPossibilities(e,"l")}else{e=this.removeDirectionFromPossibilities(e,"l")}}var g=e[Math.floor(Math.random()*e.length)];f.attr("src","img/"+g+".jpg");this.tileHistory.resetTile(f);this.tileDebugger.resetTile(f)}.bind(this);this.getDirectionsOfTile=function(d){return d.attr("src").match(/([\w]+)\.[\w]+/i)[1]};this.getRandomTile=function(){var d=Math.floor(Math.random()*this.maxWidth+1);var e=Math.floor(Math.random()*this.maxHeight+1);return $('[data-x="'+d+'"][data-y="'+e+'"]')}.bind(this);this.initialize()}function TileHistory(a){this.$playfield=a;this.maxWidth=this.$playfield.data("maximum-x");this.maxHeight=this.$playfield.data("maximum-y");this.history=[];this.resetTile=function(b){this.history[(b.data("y")-1)][(b.data("x")-1)]=0}.bind(this);this.initialize=function(){var c=[];for(var b=1;b<this.maxWidth;b++){c.push(0)}for(var d=1;d<this.maxHeight;d++){this.history.push(c)}}.bind(this);this.initialize()}function Debugger(){this.resetTile=function(a){a.css({opacity:1})}}var debugMode=false;var randomizer;var randomizer_active=false;var randomizer_speed=1;var walker;var walker_active=false;var walker_speed=150;var wloc=[];var camefrom;var history=true;function setWalker(){var c=$(wloc.id).attr("src");if(c!="img/x.jpg"){$("#walker").animate({left:(wloc.h*30)-19,top:(wloc.v*30)+7},walker_speed,function(){if(walker_active){walk()}});if(history){visited["v"+wloc.v]["h"+wloc.h]++}if(debugMode){var a=$(wloc.id).css("opacity");if(a>0.14){var b=Math.round((a-0.05)*100)/100;if(a==1){b=0.5}$(wloc.id).css({opacity:b})}}}else{startWalker()}}function startWalker(){wloc=getRandomTile();while($(wloc.id).attr("src")=="img/x.jpg"){wloc=getRandomTile()}setWalker();$("#walker").show(250)}function removeVisited(c,a){if(a=="t"){v=(wloc.v-1);h=wloc.h}if(a=="r"){v=wloc.v;h=(wloc.h+1)}if(a=="b"){v=(wloc.v+1);h=wloc.h}if(a=="l"){v=wloc.v;h=(wloc.h-1)}if(c.length>1){if(c.indexOf(a)!=-1){if(visited["v"+v]["h"+h]>0){var b=new RegExp(a,"g");c=c.replace(b,"")}}}return c}function walk(){var e=$(wloc.id).attr("src");var d=e.substring(4,e.length-4);if(d.length>1){var c=new RegExp(camefrom,"g");d=d.replace(c,"")}if(history&&d.length>1){var b;var f=[];if(d.indexOf("t")!=-1&&wloc.v>1){f.t=visited["v"+(wloc.v-1)]["h"+wloc.h]}else{f.t=99999}b=f.t;if(d.indexOf("r")!=-1&&wloc.h<(maxWidth-1)){f.r=visited["v"+wloc.v]["h"+(wloc.h+1)]}else{f.r=99999}if(f.r<b){b=f.r}if(d.indexOf("b")!=-1&&wloc.v<(maxHeight-1)){f.b=visited["v"+(wloc.v+1)]["h"+wloc.h]}else{f.b=99999}if(f.b<b){b=f.b}if(d.indexOf("l")!=-1&&wloc.h>1){f.l=visited["v"+wloc.v]["h"+(wloc.h-1)]}else{f.l=99999}if(f.l<b){b=f.l}d="";if(f.t==b){d="t"}if(f.r==b){d=d+"r"}if(f.b==b){d=d+"b"}if(f.l==b){d=d+"l"}}var a=d[(Math.floor(Math.random()*(d.length)))];if(a=="t"){wloc.v--;camefrom="b"}if(a=="r"){wloc.h++;camefrom="l"}if(a=="b"){wloc.v++;camefrom="t"}if(a=="l"){wloc.h--;camefrom="r"}wloc.id="#v"+wloc.v+"h"+wloc.h;setWalker()}function clearBoard(){if(walker_active==true){disableWalker()}$("#playfield img.tile").attr("src","img/x.jpg");visited=setupVisited()}function toggleRandomizer(){if(randomizer_active==true){clearInterval(randomizer);randomizer_active=false;$("#randomizer_state").css("text-decoration","none")}else{randomizer=setInterval(replaceTile,randomizer_speed);randomizer_active=true;$("#randomizer_state").css("text-decoration","underline")}}function enableWalker(){startWalker();walker_active=true;$("#walker_state").css("text-decoration","underline")}function disableWalker(){$("#walker").hide(250);walker_active=false;$("#walker_state").css("text-decoration","none")}function toggleWalker(){var a=false;$("#playfield img.tile").each(function(){if($(this).attr("src")!="img/x.jpg"){a=true}});if(a==true){if(walker_active==true){disableWalker()}else{enableWalker()}}else{alert("No tiles to walk... :(")}}function toggleHistory(){if(history==false){history=true;$("#history_state").css("text-decoration","underline")}else{history=false;$("#history_state").css("text-decoration","none")}}function toggleDebugMode(){if(debugMode==false){debugMode=true;$("#debug_state").css("text-decoration","underline")}else{debugMode=false;$("#playfield img.tile").css({opacity:1});$("#debug_state").css("text-decoration","none")}}(function(c){var d=c("#playfield");var b=new TileHistory(d);var a=new Debugger();var e=new RandomPatternGenerator(d,b,a);c("#playfield img.tile").mouseover(function(){e.replaceTile(c(this))});c("body").keyup(function(f){switch(f.keyCode){case 67:clearBoard();break;case 82:toggleRandomizer();break;case 87:toggleWalker();break;case 72:toggleHistory();break;case 68:toggleDebugMode();break}});c("footer li a").click(function(){switch(c(this).data("action")){case"clear":clearBoard();break;case"randomize":toggleRandomizer();break;case"walker":toggleWalker();break;case"history":toggleHistory();break;case"debug":toggleDebugMode();break}return false})})(jQuery);